# Сборка из исходного кода
Плагин EasyPayments может быть собран из исходного кода, например, если Вы хотите внести какие-то изменения
в него и использовать уже модифицированный плагин на сервере.

> [!IMPORTANT]
> Если столкнетесь с проблемами при сборке - создайте **issue** в этом репозитории.<br>
> Помощь со сборкой из исходного кода осуществляется **только в issues**.

## Подготовка к сборке
Для осуществления сборки необходимо иметь:
- **Java 21** или новее.<br>
  В ходе сборки могут потребоваться и другие версии - Gradle установит их автоматически.

## Последовательность действий
Для сборки плагина из исходного кода необходимо выполнить следующее:
1. Клонируйте этот репозиторий и переместитесь в его локальную директорию:
   ```bash
   git clone https://github.com/EasyDonate/EasyPayments.git
   cd EasyPayments
   ```
2. Запустите сборку плагина:
   ```bash
   ./gradlew shadowJar
   ```
3. Получите готовый jar-файл плагина по пути `build/EasyPayments-X.Y.Z.jar`.

> [!IMPORTANT]
> В таком случае, Вы можете получить сборку EasyPayments с ограниченной поддержкой,
> т.е. не каждая версия игры будет поддерживаться. Более подробно этот момент описан далее.

# Тонкая настройка сборки

## Ключи платформ
Для начала нужно решить, какая из реализаций платформ Вам подходит. Ядро указано
как минимальное поддерживаемое — ожидается, что все форки от него тоже будут
поддерживаемыми, но это [не гарантируется](/docs/3rd-party-platforms.md).

|                                                                        | `paper-universal` | `paper-internals` | `spigot-internals` |
|------------------------------------------------------------------------|:-----------------:|:-----------------:|:------------------:|
| Требуемое ядро                                                         | Paper **1.18.1+** | Paper **1.20.6+** |  Spigot **1.8+**   |
| Схема реализации                                                       |     Paper API     |        NMS        |        NMS         |
| Обновляется после выхода<br>новой версии игры                          |        Нет        |        Нет        |         Да         |
| Поддерживает изменение<br>никнейма и уровня прав<br>исполнителя команд |        Нет        |        Да         |         Да         |
| Требует наличия сборок<br>Spigot нужных версий                         |        Нет        |        Нет        |         Да         |
| Поддерживает Folia                                                     |        Да         |        Да         |         Да         |

> [!IMPORTANT]
> Если Вы используете Paper на версии игры **ниже 1.18.1**, можете даже не смотреть на
> `paper-*` платформы, для Вас только один вариант — `spigot-internals`.

> [!TIP]
> По причине того, что `paper-universal` реализована встроенными средствами Paper API,
> эта платформа является **более предпочтительной**, если Ваш сервер работает на
> Paper **1.18.1** или новее.

> [!NOTE]
> Между `paper-internals` и `spigot-internals` есть тонкая грань.<br>
> Дело в том, что начиная с Paper **1.20.6** разработчики ядра убрали релокейт
> корневого пакета CraftBukkit. То есть, если раньше он мог быть *org.bukkit.craftbukkit.**v1_20_R4***,
> то теперь он всегда *org.bukkit.craftbukkit* — это позволяет избавиться от необходимости
> добавлять поддержку для новых версий игры в `paper-internals`.

## Конфигурация сборки
Теперь, когда Вы определились с подходящими платформами, можно рассмотреть свойства Gradle,
которыми настраивается композиция сборки:

- `buildFolia` *(по умолчанию — **true**)*<br>
  Указывает на то, нужно ли собирать плагин с поддержкой **Folia**.<br>
  Возможные значения: *true*, *false*.

- `buildPlatforms` *(по умолчанию — **all**)*<br>
  Указывает на то, какие реализации платформы нужно включить в плагин.<br>
  Возможные значения: *all*, *paper-universal*, *paper-internals*, *spigot-internals*.<br>
  Несколько платформ могут быть перечислены через запятую.

- `buildSpigot` *(по умолчанию — **only-installed**)*<br>
  Указывает на то, какие реализации платформы `spigot-internals` нужно включить в плагин.<br>
  Возможные значения: *all*, *only-installed*, *(version)*.<br>
  Несколько версий могут быть перечислены через запятую.

Вот несколько примеров, как это можно использовать:
- Собрать EasyPayments под Paper **1.18.1+** без поддержки Folia.
  ```bash
  ./gradlew clean build \
      -PbuildFolia=false \
      -PbuildPlatforms=paper-universal
  ```
- Собрать EasyPayments под Spigot **1.16.5** и **1.17.1**.
  ```bash
  ./gradlew clean build \
      -PbuildFolia=false \
      -PbuildPlatforms=spigot-internals \
      -PbuildSpigot='1.16.5,1.17.1'
  ```
- Собрать EasyPayments под версии Spigot, которые есть в системе.
  ```bash
  ./gradlew clean build \
      -PbuildFolia=false \
      -PbuildPlatforms=spigot-internals \
      -PbuildSpigot=only-installed
  ```
- Собрать EasyPayments под Paper **1.20.6+**.
  ```bash
  ./gradlew clean build \
      -PbuildPlatforms=paper-internals
  ```

## Автоматическая сборка Spigot
В композиции сборки плагина по умолчанию настройки выставлены таким образом, что реализация
на основе NMS под конкретные версии Spigot происходит только в том случае, если все нужные
зависимости Spigot соответствующей версии лежат в локальном репозитории Maven — то есть,
если Spigot соответствующей версии был собран через BuildTools на данном устройстве.

Система сборки здесь настроена таким образом, что `spigot-internals` компилируется только
под 4 версии NMS: *1.8.R1*, *1.13.R1*, *1.17.R1* и *1.19.R1* — для остальных версий эти
4 JAR-файла просто ремаппятся. Но для ремаппинга всё равно нужны карты обфускации Mojang
и Spigot, а значит Вам придётся собрать как минимум 2+15 версий Spigot, чтобы собрать
плагин универсальным под **1.8 - 1.21.8**. Если все необходимые артефакты уже присутствуют
в локальном репозитории Maven, сборка соответствующей версии будет пропущена.

Если Вы изучили внутреннее устройство платформ и поняли различия между ними, то вполне
может быть такое, что Вам понадобится именно `spigot-internals` платформа под ту версию
игры, на которой работает Ваш сервер. В этом случае, у Вас есть два пути...

### Сборка всех используемых версий
Вы можете собрать все версии Spigot, которые поддерживает плагин.<br>
На текущий момент, актуальна версия NMS 1.21.R5 (MC 1.21.8), а это 30+ версий с 1.8.R1.
```bash
# build Spigot 1.8 - 1.21.8 using BuildTools
./gradlew buildAllSpigot
```

### Сборка необходимых версий
Задача `buildAllSpigot` является агрегирующей для дочерних `buildSpigot@<version>`,
поэтому Вы можете вызвать их напрямую, чтобы собрать только интересующие Вас версии.
```bash
# build Spigot 1.16.5 (NMS 1.16.R3)
./gradlew buildSpigot@1.16.5
```

> [!IMPORTANT]
> Обратите внимание, что в плагине используются схема, в которой каждой версии NMS
> соответствует именно **последняя** версия игры. То есть, если Вам нужна поддержка
> Spigot 1.16.4, то это NMS 1.16.R3, а значит в списке задач Gradle будет только
> `buildSpigot@1.16.5`, т.к. Spigot 1.16.5 — это последняя версия игры на NMS 1.16.R3.

> [!TIP]
> Разумеется, таких задач может быть указано несколько сразу, но выполняться они всё
> равно будут последовательно.
