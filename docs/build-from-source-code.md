# Сборка из исходного кода
Плагин EasyPayments может быть собран из исходного кода, например, если Вы хотите внести какие-то изменения
в него и использовать уже модифицированный плагин на сервере.

## Подготовка к сборке
Для осуществления сборки необходимо иметь:
- **Java 21** или новее.<br>
  В ходе сборки потребуются и другие версии (8, 16, 17) - Gradle установит их автоматически.
- JAR-файлы **Spigot с внутренним кодом игры** (NMS) для версий: `1.8`, `1.13`, `1.17.1` и `1.19`.<br>
  Сборка необходимых файлов может быть осуществлена автоматически или вручную (см. ниже).
  Рекомендуется в любом случае запустить автоматическую сборку для устранения возможных ошибок.

### Автоматическая сборка Spigot
После клонирования репозитория необходимые файлы Spigot могут быть собраны автоматически
при помощи задачи `buildAllSpigot` в корневом проекте Gradle. Если все необходимые
артефакты уже присутствуют в локальном репозитории Maven, сборка соответствующей версии
будет пропущена.

Используйте исполняемые файлы _gradlew_ для вызова этой задачи:
```bash
# Windows
gradlew.bat buildAllSpigot --info

# Linux или Mac OS
./gradlew buildAllSpigot --info
```
Сборка происходит последовательно, поэтому придется подождать...


## Частичная сборка
Прекрасно понимаю, что собирать **30+** версий Spigot не каждому захочется,
тем более, если сервер на свежем Paper, поэтому существует вариант частичной
сборки плагина. Это достигается с помощью нескольких переменных окружения,
которые могут быть установлены для Gradle во время сборки.

### Ключи платформ
Для начала нужно решить, какая из реализаций платформ Вам подходит. Ядро указано
как минимальное поддерживаемое — ожидается, что все форки от него тоже будут
поддерживаемыми, но это [не гарантируется](/docs/3rd-party-platforms.md).

|                                                                        | `paper-universal` | `paper-internals` | `spigot-internals` |
|------------------------------------------------------------------------|:-----------------:|:-----------------:|:------------------:|
| Требуемое ядро                                                         | Paper **1.18.1+** | Paper **1.20.6+** |  Spigot **1.8+**   |
| Схема реализации                                                       |     Paper API     |        NMS        |        NMS         |
| Обновляется после выхода<br>новой версии игры                          |        Нет        |        Нет        |         Да         |
| Поддерживает изменение<br>никнейма и уровня прав<br>исполнителя команд |        Нет        |        Да         |         Да         |
| Требует наличия сборок<br>Spigot нужных версий                         |        Нет        |        Нет        |         Да         |
| Поддерживает Folia                                                     |        Да         |        Да         |         Да         |

> [!IMPORTANT]
> Если Вы используете Paper на версии игры **ниже 1.18.1**, можете даже не смотреть на
> `paper-*` платформы, для Вас только один вариант — `spigot-internals`.

> [!TIP]
> По причине того, что `paper-universal` реализована встроенными средствами Paper API,
> эта платформа является **более предпочтительной**, если Ваш сервер работает на
> Paper **1.18.1** или новее.

> [!NOTE]
> Между `paper-internals` и `spigot-internals` есть тонкая грань.<br>
> Дело в том, что начиная с Paper **1.20.6** разработчики ядра убрали релокейт
> корневого пакета CraftBukkit. То есть, если раньше он мог быть *org.bukkit.craftbukkit.**v1_20_R4***,
> то теперь он всегда *org.bukkit.craftbukkit* — это позволяет избавиться от необходимости
> добавлять поддержку для новых версий игры в `paper-internals`.

### Управление частичной сборкой
Теперь, когда Вы определились с подходящими платформами, можно рассмотреть переменные окружения,
которыми контролируется частичная сборка:

- `easypayments.build.folia` *(по умолчанию — **true**)*<br>
  Указывает на то, нужно ли собирать плагин с поддержкой **Folia**.<br>
  Возможные значения: *true*, *false*.

- `easypayments.build.platforms` *(по умолчанию — **all**)*<br>
  Указывает на то, какие реализации платформы нужно включить в плагин.<br>
  Возможные значения: *all*, *paper-universal*, *paper-internals*, *spigot-internals*.<br>
  Несколько платформ могут быть перечислены через запятую.

- `easypayments.build.spigot` *(по умолчанию — **only-installed**)*<br>
  Указывает на то, какие реализации платформы `spigot-internals` нужно включить в плагин.<br>
  Возможные значения: *all*, *only-installed*, *(version)*.<br>
  Несколько версий могут быть перечислены через запятую.

Вот несколько примеров, как это можно использовать:
- Собрать EasyPayments под Paper **1.18.1+** без поддержки Folia.
  ```bash
  ./gradlew clean build \
      -Deasypayments.build.folia=false \
      -Deasypayments.build.platforms=paper-universal
  ```
- Собрать EasyPayments под Spigot **1.16.5** и **1.17.1**.
  ```bash
  ./gradlew clean build \
      -Deasypayments.build.folia=false \
      -Deasypayments.build.platforms=spigot-internals \
      -Deasypayments.build.spigot=1.16.5,1.17.1
  ```
- Собрать EasyPayments под версии Spigot, которые есть в системе.
  ```bash
  ./gradlew clean build \
      -Deasypayments.build.folia=false \
      -Deasypayments.build.platforms=spigot-internals \
      -Deasypayments.build.spigot=only-installed
  ```
- Собрать EasyPayments под Paper **1.20.6+**.
  ```bash
  ./gradlew clean build \
      -Deasypayments.build.platforms=paper-internals
  ```

## Последовательность действий
Для сборки плагина из исходного кода необходимо выполнить следующее:
1. Клонируйте этот репозиторий и переместитесь в его локальную директорию:
   ```bash
   git clone https://github.com/EasyDonate/EasyPayments.git
   cd EasyPayments
   ```
2. Рекомендуется запустить автоматическую сборку Spigot (см. выше).
3. Запустите сборку плагина:
   ```bash
   # Windows
   gradlew.bat clean build

   # Linux или Mac OS
   ./gradlew clean build
   ```
4. Получите готовый jar-файл плагина по пути `build/EasyPayments-X.Y.Z.jar`.

Если столкнетесь с проблемами при сборке - создайте **issue** в этом репозитории.<br>
Помощь со сборкой из исходного кода осуществляется **только в issues**.
